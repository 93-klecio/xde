{"version":3,"sources":["application/PackagerController.js"],"names":[],"mappings":"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","file":"application/PackagerController.js","sourcesContent":["let child_process = require('child_process');\nlet crayon = require('@ccheever/crayon');\nlet freeportAsync = require('freeport-async');\nlet instapromise = require('instapromise');\nlet ngrok = require('ngrok');\nlet path = require('path');\nlet events = require('events');\n\nlet urlUtils = require('./urlUtils');\n\nclass PackagerController extends events.EventEmitter {\n  constructor(opts) {\n    super(opts);\n\n    let DEFAULT_OPTS = {\n      port: undefined,\n      // packagerPath: path.join(__dirname, '..', '..', 'node_modules/react-native/packager/packager.sh'),\n      packagerJSPath: path.join(__dirname, '..', '..', 'node_modules/react-native/packager/packager.js'),\n      mainModulePath: 'index.js',\n      // absolutePath: root,\n    };\n\n    this.opts = Object.assign(DEFAULT_OPTS, opts);\n    this._givenOpts = opts;\n\n    global._PackagerController = this;\n\n  }\n\n  async startOrRestartNgrokAsync() {\n\n    if (this._ngrokUrl) {\n      console.log(\"Waiting for ngrok to disconnect...\");\n      await this._stopNgrokAsync();\n      console.log(\"Disconnected ngrok; restarting...\");\n    }\n\n    this.ngrokReady$ = new Promise((fulfill, reject) => {\n      this._ngrokReadyFulfill = fulfill;\n      this._ngrokReadyReject = reject;\n    });\n\n    this.emit('ngrok-will-start', this.opts.port);\n    this.ngrokReady$ = ngrok.promise.connect(this.opts.port);\n    // this._setCombinedPromises();\n    this._ngrokUrl = await this.ngrokReady$;\n    this.emit('ngrok-did-start', this.opts.port, this._ngrokUrl);\n    this.emit('ngrok-ready', this.opts.port, this._ngrokUrl);\n\n    console.log(\"Connected ngrok to port \" + this.opts.port + \" via \" + this._ngrokUrl);\n    return this._ngrokUrl;\n  }\n\n  async startOrRestartPackagerAsync() {\n\n    if (!this.opts.port) {\n      throw new Error(\"`this.opts.port` must be set before starting the packager!\");\n    }\n\n    let root = this.opts.absolutePath;\n    if (!root) {\n      throw new Error(\"`this.opts.absolutePath` must be set to start the packager!\");\n    }\n\n    await this._stopPackagerAsync();\n\n    // TODO: We might need to adjust `ulimit -n 4096`\n    // which packager.sh does but calling the JS\n    // directly doesn't, but maybe not if we\n    // switch to chokidar?\n    let node = path.resolve(path.join(__dirname, '../../io.js/v2.3.1/bin/node'));\n    let packagerProcess = child_process.spawn(node, [this.opts.packagerJSPath, \"--port=\" + this.opts.port, \"--projectRoots=\" + root, \"--assetRoots=\" + root,], {\n        // stdio: [process.stdin, process.stdout, process.stderr],\n        // stdio: 'inherit',\n        // detached: false,\n        env: Object.assign({}, process.env, {\n          NODE_PATH: null,\n        }),\n      });\n    process.on('exit', () => {\n      packagerProcess.kill();\n    });\n    this._packager = packagerProcess;\n    this._packager.stdout.setEncoding('utf8');\n    this._packager.stderr.setEncoding('utf8');\n    this._packager.stdout.on('data', (data) => {\n      this.emit('stdout', data);\n\n      if (data.match(/React packager ready\\./)) {\n        // this._packagerReadyFulfill(this._packager);\n        // this._packagerReady = true;\n        this.emit('packager-ready', this._packager);\n      }\n\n      // crayon.yellow.log(\"STDOUT:\", data);\n    });\n\n    this._packager.stderr.on('data', (data) => {\n      this.emit('stderr', data);\n      // crayon.orange.error(\"STDERR:\", data);\n    });\n\n    this.packagerExited$ = new Promise((fulfill, reject) => {\n      this._packagerExitedFulfill = fulfill;\n      this._packagerExitedReject = reject;\n    });\n\n    this._packager.on('exit', (code) => {\n      console.log(\"packager process exited with code\", code);\n      // console.log(\"packagerExited$ should fulfill\");\n      this._packagerExitedFulfill(code);\n      this.emit('packager-stopped', code);\n    });\n\n  }\n\n  async _stopPackagerAsync() {\n\n    if (this._packager && (!this._packager.killed && (this._packager.exitCode === null))) {\n      console.log(\"Stopping packager...\");\n      let stopped$ = new Promise((fulfill, reject) => {\n        let timeout = setTimeout(() => {\n          console.error(\"Stopping packager timed out!\");\n          reject();\n        }, 10000);\n        this._packager.on('exit', (exitCode) => {\n          clearTimeout(timeout);\n          fulfill(exitCode);\n        });\n      });\n      this.emit('packager-will-stop');\n      this._packager.kill('SIGTERM');\n      return stopped$;\n    } else {\n      console.log(\"Packager already stopped.\");\n    }\n  }\n\n  async _stopNgrokAsync() {\n\n    if (this._ngrokUrl) {\n      this.emit('ngrok-will-disconnect', this._ngrokUrl);\n      try {\n        await ngrok.promise.disconnect(this._ngrokUrl);\n        let oldNgrokUrl = this._ngrokUrl;\n        this._ngrokUrl = null;\n        // this._ngrokDisconnectedFulfill(oldNgrokUrl);\n        // console.log(\"Disconnected ngrok\");\n        this.emit('ngrok-disconnected', oldNgrokUrl);\n      } catch (e) {\n        console.error(\"Problem disconnecting ngrok:\", e);\n        // this._ngrokDisconnectedReject(e);\n        this.emit('ngrok-disconnect-err', e);\n      }\n    }\n\n  }\n\n  async startAsync() {\n\n    // let root = this.opts.absolutePath;\n    if (!this.opts.port) {\n      this.opts.port = await freeportAsync(19000);\n    }\n\n    await Promise.all([\n      this.startOrRestartPackagerAsync(),\n      this.startOrRestartNgrokAsync(),\n    ]);\n\n    return this;\n  }\n\n  async getUrlAsync(opts) {\n    return urlUtils.constructUrlAsync(this, opts);\n  }\n\n  async getNgrokUrlAsync() {\n    return this._ngrokUrl;\n  }\n\n  getNgrokUrl() {\n    return this._ngrokUrl;\n  }\n\n  getProjectShortName() {\n    return path.parse(this.opts.absolutePath).base;\n  }\n\n}\n\nmodule.exports = PackagerController;\n\nmodule.exports.testIntance = function (opts) {\n  let pc = new PackagerController(Object.assign({}, {\n    absolutePath: '/Users/ccheever/tmp/icecubetray',\n  }, opts));\n  pc.on('stdout', crayon.green.log);\n  pc.on('stderr', crayon.red.log);\n  pc.on('packager-stopped', () => {\n    crayon.orange('packager-stopped');\n  });\n  pc.startAsync();\n  return pc;\n}\n"],"sourceRoot":"/source/"}